name: Publish Helm Chart to Harbor (Legacy Repository)

on:
  push:
    branches:
      - dev
  pull_request:

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository
      - name: Checkout Code
        uses: actions/checkout@v3

      # Step 2: Setup Helm
      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.12.0

      # Step 3: Install Helm Push Plugin (for legacy Helm repository)
      - name: Install Helm Push Plugin
        run: |
          helm plugin install https://github.com/chartmuseum/helm-push

      # Step 4: Lint Helm Chart
      - name: Lint Helm Chart
        run: helm lint ./helm-charts/itshop-helm

      # Step 5: Package Helm Chart
      - name: Package Helm Chart
        run: |
          helm package ./helm-charts/itshop-helm -d ./helm-charts/packages
          ls -l ./helm-charts/packages

      # Step 6: Push Helm Chart to Legacy Harbor Repository
      - name: Push Helm Chart to Harbor (Legacy)
        env:
          HARBOR_URL: ${{ secrets.HARBOR_URL }}
          HARBOR_USERNAME: ${{ secrets.HARBOR_USERNAME }}
          HARBOR_PASSWORD: ${{ secrets.HARBOR_PASSWORD }}
        run: |
          # Add the legacy Helm repository
          helm repo add harbor-helm oci://$HARBOR_URL/chartrepo/helm-test --username $HARBOR_USERNAME --password $HARBOR_PASSWORD

          # Push the packaged Helm chart
          CHART_NAME=$(ls ./helm-charts/packages/*.tgz)
          helm push $CHART_NAME harbor-helm
